---
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: false
    self_contained: yes
    keep_md: no
pagetitle: final_project_report
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

## [Home](https://annettelewis.github.io/) | [About Me](https://annettelewis.github.io/about_me/) | [Projects](https://annettelewis.github.io/projects/) | [Final Project](https://annettelewis.github.io/final_project/)

## Information on data:
The following data is on New Orleans tornado building damage during December 2022. This data was obtained from Verisk Analytics and it was derived computer vision and machine learning using post-catastrophe aerial imagry data. There are approximately 42,000 buildings in this dataset. 

---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(janitor)
library(leaflet)
library(easystats)
library(modelr)
# library(ggmap)
# library(sf)
# library(GGally)
# library(plotly)
library(kableExtra)
library(patchwork)
library(stringr)
library(htmltools)
library(devtools)
# library(htmlwidgets)
# library(webshot2)
theme_set(theme_minimal())
```

## Clean data:

I converted roof_solar into a T/F statement, by converting "SOLAR PANEL" to TRUE and "NO SOLAR PANEL" to FALSE. In addition to this, I converted the roof shapes that the computer wasn't very sure about (up to a 20% chance of being incorrect) into NA. There were some cells in damage_level where they were filled with an empty character, so I converted that into NA as well. I then separated longitude and latitude so that it could be easily read into leaflet. 

```{r}
df <- read.csv("clean_data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(roofsolar = case_when(roofsolar == "SOLAR PANEL" ~ TRUE)) %>%
  mutate(roofshape = ifelse(roofshascr < 0.80, NA, roofshape)) %>%
  select(-c(roofshascr, roofcondit_discolordetect, roofcondit_discolorscore, roofcondit_discolorpercen, trampscr, roofcondit_tarppercen))

df$rooftopgeo <- gsub("POINT \\(|\\)", "", df$rooftopgeo)

df <- df %>%
  separate(rooftopgeo, into = c("long", "lat"), sep = " ", convert = TRUE)

df$damage_level <- ifelse(df$damage_level == "", NA, df$damage_level)
```
---

```{r}
# df %>%
#   select(-buildings_ids) %>%
#   kable() %>%
#   kable_classic(lightable_options = "hover") %>%
#   scroll_box(height = "200px")
```

## Define damage categories:

Catastrophe scores are separated by the summary of the dataset, excluding the catastrophe scores of 0.

```{r, echo = TRUE}
mostdamage <- df %>% filter(catastrophescore >= 50)
nodamage <- df %>% filter(catastrophescore == 0)
decimated <-df %>% filter(catastrophescore == 100)
middamage <- df %>% filter(catastrophescore < 50 & catastrophescore >= 15)
leastdamage <- df %>% filter(catastrophescore < 15 & catastrophescore >= 2)
minimaldamage <- df %>% filter(catastrophescore == 1)
```

Function for adding labels to the maps:

```{r, echo = TRUE}
create_popup <- function(data) {
  paste("<b>Location</b><br>",
        "&nbsp;&nbsp;&nbsp;Longitude: ", data$long, "<br>",
        "&nbsp;&nbsp;&nbsp;Latitude: ", data$lat, "<br>",
        "<b>Catastrophe Score</b><br>",
        "&nbsp;&nbsp;&nbsp;Score: ", data$catastrophescore, "<br>",
        "<b>Roof Shape</b><br>",
        "&nbsp;&nbsp;&nbsp;Shape: ", str_to_title(data$roofshape), "<br>",
        "<b>Roof Material</b><br>",
        "&nbsp;&nbsp;&nbsp;Material: ", str_to_title(data$roofmateri), "<br>")
}
```

## Damage maps:

This shows all of the damage points, the vast majority of roofs have no damage.

```{r, out.height= 450, out.width = 675}
# alldamage <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
#   addTiles() %>%
#   addCircleMarkers(lng=mostdamage$long, lat=mostdamage$lat, color = "red", radius = 2) %>%
#   addCircleMarkers(lng=middamage$long, lat=middamage$lat, color = "orange", radius = 2) %>%
#   addCircleMarkers(lng=leastdamage$long, lat=leastdamage$lat, color = "blue", radius = 2) %>%
#   addCircleMarkers(lng=nodamage$long, lat=nodamage$lat, color = "gray", radius = .5) %>%
#   setMaxBounds(lng1 = min(mostdamage$long, middamage$long, leastdamage$long, nodamage$long),
#                lat1 = min(mostdamage$lat, middamage$lat, leastdamage$lat, nodamage$lat),
#                lng2 = max(mostdamage$long, middamage$long, leastdamage$long, nodamage$long),
#                lat2 = max(mostdamage$lat, middamage$lat, leastdamage$lat, nodamage$lat))
# alldamage_map <- saveWidget(alldamage, file = "alldamage_map.html", selfcontained = TRUE)
# webshot2::webshot("alldamage_map.html", "alldamage_map.png", cliprect = "viewport", zoom = 5)

knitr::include_graphics("./maps/alldamage.png")
```


---

*These are the buildings that sustained damage*

Red indicates the buildings that were the most damaged (catastrophe score >= 50), orange indicates (25 < catastrophe score < 50), blue indicates (catastrophe score <= 25, excluding scores of 0). The majority of the buildings (3852) exhibited a catastrophe score of 0.

Map of the buildings that experienced damage:

```{r, out.height= 450, out.width = 675}
# damage <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
#   addTiles() %>%
#   addCircleMarkers(lng=mostdamage$long, lat=mostdamage$lat, color = "red", radius = 2, popup = create_popup(mostdamage)) %>%
#   addCircleMarkers(lng=middamage$long, lat=middamage$lat, color = "orange", radius = 2, popup = create_popup(middamage)) %>%
#   addCircleMarkers(lng=leastdamage$long, lat=leastdamage$lat, color = "blue", radius = 2, popup = create_popup(leastdamage))
# damage_map <- saveWidget(damage, file = "damage_map.html", selfcontained = TRUE)
# webshot2::webshot("damage_map.html", "damage_map.png", cliprect = "viewport", zoom = 5)

knitr::include_graphics("./maps/damage.png")
```

Map of the buildings that experienced the most damage:

```{r}
high <- leaflet() %>%
  addTiles() %>%
  addCircleMarkers(lng = mostdamage$long, lat = mostdamage$lat, color = "red", radius = 2, 
                   popup = create_popup(mostdamage))
high
```

Map of the buildings that experienced mid damage:

```{r, out.height= 450, out.width = 675}
# mid <- leaflet() %>%
#   addTiles() %>%
#   addCircleMarkers(lng=middamage$long, lat=middamage$lat, color = "orange", radius = 2,
#                    popup = create_popup(middamage))
# middamage_map <- saveWidget(mid, file = "middamage_map.html", selfcontained = TRUE)
# webshot2::webshot("middamage_map.html", "middamage_map.png", cliprect = "viewport", zoom = 5)

knitr::include_graphics("./maps/leastdamage.png")
```

Map of the buildings that experienced the least damage:

```{r, out.height= 450, out.width = 675}
# least <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
#   addTiles() %>%
#   addCircleMarkers(lng=leastdamage$long, lat=leastdamage$lat, color = "blue", radius = 2,
#                    popup = create_popup(leastdamage))
# leastdamage_map <- saveWidget(least, file = "leastdamage_map.html", selfcontained = TRUE)
# webshot2::webshot("leastdamage_map.html", "leastdamage_map.png", cliprect = "viewport", zoom = 5)

knitr::include_graphics("./maps/leastdamage.png")
```

Map of the buildings that experienced no damage:

```{r, out.height= 450, out.width = 675}
# none <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
#   addTiles() %>%
#   addCircleMarkers(lng=nodamage$long, lat=nodamage$lat, color = "gray", radius = .5,
#                    popup = create_popup(nodamage))
# none_map <- saveWidget(none, file = "none_map.html", selfcontained = TRUE)
# webshot2::webshot("none_map.html", "none_map.png", cliprect = "viewport", zoom = 5)

knitr::include_graphics("./maps/none.png")
```

Map of the buildings that experienced no damage and the most damage:

```{r}
destroyed <- leaflet() %>%
  addTiles() %>%
  addCircleMarkers(lng=decimated$long, lat=decimated$lat, color = "#800000", radius = 2,
                   popup = create_popup(decimated))
destroyed
```

---

## Models:

```{r}
# mod1 <- df %>% glm(formula = catastrophescore ~ long + lat + rooftree + roofshape, family = "gaussian")
# mod2 <- df %>% glm(formula = catastrophescore ~ long + lat + roofshape + rooftree + roofmateri, family = "gaussian")
# mod3 <- df %>% glm(formula = catastrophescore ~ long + lat + trampoline + deck + pool + enclosure + divingboar + waterslide + playground + sportcourt + primarystr + roofsolar + rooftree + roofmateri * roofshape, family = "gaussian")
mod3 <- df %>% glm(formula = catastrophescore ~ long + lat + enclosure + roofmateri + roofsolar + rooftree + roofshape, family = "gaussian")
mod4 <- df %>% glm(formula = catastrophescore ~ long + lat + roofshape + rooftree + roofmateri + trampoline * deck * pool * enclosure * divingboar * waterslide * playground * sportcourt * primarystr * roofsolar, family = "gaussian")
mod5 <- df %>% glm(formula = catastrophescore ~ long + lat + trampoline * deck * pool * enclosure * divingboar * waterslide * playground * sportcourt * primarystr * roofsolar + roofmateri + roofshape + rooftree, family = "gaussian")

# compare_performance(mod1, mod2, mod3, mod4, mod5) %>% plot()
# compare_performance(mod1, mod2, mod3, mod4, mod5)
compare_performance(mod3, mod4, mod5) %>% plot()
compare_performance(mod3, mod4, mod5)

# formula(mod1)
# formula(mod2)
formula(mod3)
formula(mod4)
formula(mod5)
```

## Check models 

Model 3

```{r}
check_model(mod3)
```

Model 4

```{r}
check_model(mod4)
```

Model 5

```{r}
check_model(mod5)
```

---

## Predictions:

I'm planning to add predictions and additional plots for the completed final project.

---

## Interpretations of predictions and models used:

This will also be updated.
